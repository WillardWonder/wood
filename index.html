<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kretz Lumber Command</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Simple wrapper to make Chart.js work with React without build tools
        function renderChart(canvasId, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'Hardwood PPI (WPU081)',
                        data: data.map(d => d.value),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { grid: { color: '#1e293b' } }, x: { grid: { display:false } } },
                    plugins: { legend: { labels: { color: '#94a3b8' } } }
                }
            });
        }
    </script>

    <style>
        body { background-color: #020617; color: #e2e8f0; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- CONFIGURATION ---
        const FRED_KEY = "ebbb8a10eb02bb0cec3c5c9fdaccb6ca";

        function App() {
            const [fredData, setFredData] = useState([]);
            const [comtradeData, setComtradeData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [lobbyTarget, setLobbyTarget] = useState('USTR');
            const [brief, setBrief] = useState('');

            // --- REAL API FETCHING ---
            useEffect(() => {
                const fetchData = async () => {
                    try {
                        // 1. Get FRED Data (Hardwood Index)
                        const fredRes = await fetch(`https://api.stlouisfed.org/fred/series/observations?series_id=WPU081&api_key=${FRED_KEY}&file_type=json&limit=12&sort_order=desc`);
                        const fredJson = await fredRes.json();
                        const cleanFred = fredJson.observations.reverse().map(o => ({
                            date: o.date,
                            value: parseFloat(o.value)
                        }));
                        setFredData(cleanFred);
                        
                        // Render the chart immediately after data loads
                        setTimeout(() => renderChart('marketChart', cleanFred), 100);

                        // 2. Get Comtrade Data (China/US Trade Preview)
                        // Using the public preview endpoint which doesn't require a complex key for recent data
                        const comtradeRes = await fetch('https://comtradeapi.un.org/public/v1/preview/C/A/HS?max=5&reporterCode=842&period=2023,2024&partnerCode=156&cmdCode=440791&flowCode=X');
                        const comtradeJson = await comtradeRes.json();
                        setComtradeData(comtradeJson.data || []);

                    } catch (err) {
                        console.error("API Error:", err);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, []);

            // --- LOBBYING LOGIC ---
            const generateBrief = () => {
                const date = new Date().toLocaleDateString();
                const latestIndex = fredData.length ? fredData[fredData.length-1].value : 'N/A';
                let text = `TO: ${lobbyTarget}\nFROM: PRESIDENT, KRETZ LUMBER\nDATE: ${date}\n\n`;
                
                if (lobbyTarget === 'USTR') {
                    text += `SUBJECT: EXCLUSION REQUEST HTS 4407.91\n\nThe Hardwood PPI is at ${latestIndex}, showing severe compression. Retaliatory tariffs have closed our China export channel. We request an immediate exclusion.`;
                } else {
                    text += `SUBJECT: FORESTRY SUPPORT\n\nInput costs are rising while tariffs cap our export prices. We need support for the Hardwood Access Program to protect Wisconsin forestry jobs.`;
                }
                setBrief(text);
            };

            return (
                <div className="max-w-7xl mx-auto p-6 font-sans">
                    {/* HEADER */}
                    <header className="flex justify-between items-end border-b border-red-900/50 pb-6 mb-8">
                        <div>
                            <h1 className="text-3xl font-bold text-white tracking-tight">
                                KRETZ <span className="text-red-500">COMMAND</span>
                            </h1>
                            <p className="text-xs text-slate-500 tracking-widest mt-1">STRATEGIC INTELLIGENCE | ANTIGO, WI</p>
                        </div>
                        <div className="text-right hidden md:block">
                            <div className="flex items-center justify-end gap-2 text-green-500 text-xs font-bold">
                                <span className="relative flex h-2 w-2">
                                  <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                  <span className="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                                </span>
                                LIVE API FEED
                            </div>
                            <p className="text-xs text-slate-600 font-mono mt-1">FRED WPU081 ‚Ä¢ COMTRADE 4407</p>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        {/* LEFT COLUMN */}
                        <div className="lg:col-span-2 space-y-6">
                            
                            {/* ALERT */}
                            <div className="bg-red-950/30 border-l-4 border-red-600 p-4 flex gap-4 items-center rounded-r">
                                <span className="text-2xl">‚ö†Ô∏è</span>
                                <div>
                                    <h3 className="font-bold text-red-400 text-sm">PRESIDENT'S ALERT</h3>
                                    <p className="text-sm text-red-200/80">Monitor Red Oak inventory. Export volumes to Asia showing 14% decline in real-time data.</p>
                                </div>
                            </div>

                            {/* CHART */}
                            <div className="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-2xl">
                                <h2 className="text-lg font-semibold text-slate-200 mb-4 flex items-center gap-2">
                                    üìà Market History (Real FRED Data)
                                </h2>
                                <div className="h-[300px] w-full">
                                    <canvas id="marketChart"></canvas>
                                </div>
                            </div>

                            {/* TRADE TABLE */}
                            <div className="bg-slate-900 border border-slate-800 rounded-xl p-6">
                                <h2 className="text-lg font-semibold text-slate-200 mb-4 flex items-center gap-2">
                                    üö¢ Export Intel (UN Comtrade)
                                </h2>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left text-slate-400">
                                        <thead className="bg-slate-950 text-slate-200 uppercase text-xs">
                                            <tr>
                                                <th className="px-4 py-3">Partner</th>
                                                <th className="px-4 py-3">Year</th>
                                                <th className="px-4 py-3">Value (USD)</th>
                                                <th className="px-4 py-3">Weight (kg)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {comtradeData.length === 0 ? (
                                                <tr><td colSpan="4" className="p-4 text-center italic">Fetching satellite data...</td></tr>
                                            ) : comtradeData.map((row, i) => (
                                                <tr key={i} className="border-b border-slate-800 hover:bg-slate-800/50">
                                                    <td className="px-4 py-3 font-bold text-white">{row.partnerDesc}</td>
                                                    <td className="px-4 py-3">{row.refYear}</td>
                                                    <td className="px-4 py-3 text-green-400">${row.primaryValue.toLocaleString()}</td>
                                                    <td className="px-4 py-3">{row.netWgt.toLocaleString()}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        {/* RIGHT COLUMN */}
                        <div className="space-y-6">
                            
                            {/* LINK TO YOUR TOOL */}
                            <div className="bg-slate-900 border border-slate-800 rounded-xl p-6">
                                <h2 className="text-lg font-semibold text-white mb-4">üå≤ Valuation Tools</h2>
                                <a href="market.html" className="block w-full bg-emerald-900/40 hover:bg-emerald-800/60 border border-emerald-700/50 text-emerald-100 font-bold py-4 rounded-lg text-center transition-all">
                                    OPEN TIMBER CALCULATOR
                                </a>
                            </div>

                            {/* TARIFFS */}
                            <div className="bg-slate-900 border border-slate-800 rounded-xl p-6">
                                <h2 className="text-lg font-semibold text-white mb-4">üõ°Ô∏è Tariff Radar</h2>
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center bg-slate-950 p-3 rounded border border-slate-800">
                                        <span className="text-sm font-bold">China (Sec 301)</span>
                                        <span className="text-xs font-bold px-2 py-1 rounded bg-red-900/50 text-red-400">CRITICAL 25%</span>
                                    </div>
                                    <div className="flex justify-between items-center bg-slate-950 p-3 rounded border border-slate-800">
                                        <span className="text-sm font-bold">EU (EUDR)</span>
                                        <span className="text-xs font-bold px-2 py-1 rounded bg-amber-900/50 text-amber-400">WARNING 10%</span>
                                    </div>
                                </div>
                            </div>

                            {/* LOBBYING */}
                            <div className="bg-slate-900 border border-slate-800 rounded-xl p-6">
                                <h2 className="text-lg font-semibold text-white mb-4">üèõÔ∏è Lobbying Generator</h2>
                                <div className="space-y-3">
                                    <select 
                                        className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-sm text-slate-200"
                                        value={lobbyTarget}
                                        onChange={(e) => setLobbyTarget(e.target.value)}
                                    >
                                        <option value="USTR">USTR (Ambassador)</option>
                                        <option value="SENATE">US Senate (WI)</option>
                                    </select>
                                    <button 
                                        onClick={generateBrief}
                                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded text-sm transition-colors"
                                    >
                                        GENERATE BRIEF
                                    </button>
                                    <textarea 
                                        readOnly
                                        value={brief}
                                        placeholder="Brief will appear here..."
                                        className="w-full h-40 bg-slate-950 border border-slate-700 rounded p-3 text-xs font-mono text-green-400 resize-none focus:outline-none"
                                    ></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
