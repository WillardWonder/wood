import { useEffect, useState } from 'react';
import { Line } from 'react-chartjs-2';
import { Chart as ChartJS, CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend } from 'chart.js';
import { TrendingUp, ShieldAlert, FileText, RefreshCw, ExternalLink, Activity, Server } from 'lucide-react';

ChartJS.register(CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend);

function App() {
  const [fredData, setFredData] = useState<any[]>([]);
  const [comtradeData, setComtradeData] = useState<any[]>([]);
  const [lastUpdated, setLastUpdated] = useState<string>('');
  const [loading, setLoading] = useState(true);
  const [lobbyTarget, setLobbyTarget] = useState('USTR');
  const [brief, setBrief] = useState('');

  // --- FETCH PRE-COMPILED INTELLIGENCE ---
  useEffect(() => {
    const loadIntelligence = async () => {
      try {
        setLoading(true);
        // Fetches the JSON generated by your GitHub Action
        const res = await fetch('./intelligence.json');
        
        if (!res.ok) throw new Error("Intelligence packet missing");
        
        const data = await res.json();
        
        setFredData(data.fred || []);
        setComtradeData(data.comtrade || []);
        
        // Format the "Last Updated" timestamp
        const date = new Date(data.updated);
        setLastUpdated(date.toLocaleDateString() + ' ' + date.toLocaleTimeString());
        
      } catch (err) {
        console.error("System Failure:", err);
      } finally {
        setLoading(false);
      }
    };

    loadIntelligence();
  }, []);

  const generateBrief = () => {
    const date = new Date().toLocaleDateString();
    const latestIndex = fredData.length > 0 ? fredData[fredData.length - 1].value : 'N/A';
    
    let text = `TO: ${lobbyTarget}\nFROM: PRESIDENT, KRETZ LUMBER\nDATE: ${date}\nSUBJECT: URGENT TRADE IMPACT REPORT\n\n`;
    
    if (lobbyTarget === 'USTR') {
      text += `Ambassador,\n\nThe Hardwood Producer Price Index is currently at ${latestIndex}, reflecting extreme market compression. Retaliatory tariffs from China (Sec 301) have effectively closed our primary export channel. We request an immediate exclusion for HTS 4407.91 (Red Oak) to prevent further mill curtailments in Wisconsin.`;
    } else {
      text += `Senator,\n\nInput costs for our Antigo operations are rising while export markets remain capped by tariffs. We need your support for the Hardwood Access Program in the upcoming Farm Bill to protect forestry jobs in Langlade County.`;
    }
    setBrief(text);
  };

  return (
    <div className="min-h-screen bg-slate-950 text-slate-200 font-sans p-4 md:p-8">
      {/* HEADER */}
      <header className="max-w-7xl mx-auto mb-8 border-b border-red-900/50 pb-4 flex flex-col md:flex-row justify-between items-start md:items-end">
        <div>
          <h1 className="text-3xl font-bold tracking-tight text-white">KRETZ <span className="text-red-600">COMMAND</span></h1>
          <p className="text-xs text-slate-500 tracking-widest uppercase mt-1">Strategic Hardwood Intelligence | Antigo, WI</p>
        </div>
        <div className="text-right mt-4 md:mt-0">
          <div className="flex items-center justify-end gap-2 text-green-500 text-xs font-bold">
            <Activity className="animate-pulse" size={12} /> SYSTEM ONLINE
          </div>
          <p className="text-xs text-slate-600 font-mono mt-1">
             DATA CACHED: {loading ? 'SYNCING...' : lastUpdated}
          </p>
        </div>
      </header>

      <main className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        {/* COL 1: MARKET STATUS */}
        <div className="lg:col-span-2 space-y-6">

          {/* CHART */}
          <div className="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-2xl relative overflow-hidden">
            <div className="absolute top-0 right-0 p-2 opacity-10 pointer-events-none">
                <Server size={100} />
            </div>
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-lg font-semibold flex items-center gap-2">
                <TrendingUp className="text-blue-500" size={20} />
                Market History (PPI WPU081)
              </h2>
            </div>
            <div className="h-[300px]">
              {loading ? (
                 <div className="h-full flex items-center justify-center text-slate-500 animate-pulse">Initializing Feed...</div>
              ) : (
                <Line 
                  data={{
                    labels: fredData.map(d => d.date),
                    datasets: [{
                      label: 'Hardwood PPI Index',
                      data: fredData.map(d => d.value),
                      borderColor: '#3b82f6',
                      backgroundColor: 'rgba(59, 130, 246, 0.1)',
                      fill: true,
                      tension: 0.4
                    }]
                  }}
                  options={{
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { grid: { color: '#1e293b' } }, x: { grid: { color: '#1e293b' } } }
                  }}
                />
              )}
            </div>
          </div>

          {/* TRADE DATA TABLE */}
          <div className="bg-slate-900 border border-slate-800 rounded-xl p-6">
            <h3 className="text-lg font-semibold flex items-center gap-2 mb-4">
              <ExternalLink className="text-orange-500" size={20} />
              Export Intelligence (UN Comtrade)
            </h3>
            <div className="overflow-x-auto">
              <table className="w-full text-sm text-left text-slate-400">
                <thead className="bg-slate-950 text-slate-200 uppercase">
                  <tr>
                    <th className="px-4 py-3">Partner</th>
                    <th className="px-4 py-3">Year</th>
                    <th className="px-4 py-3">Value ($USD)</th>
                    <th className="px-4 py-3">Weight (kg)</th>
                  </tr>
                </thead>
                <tbody>
                  {comtradeData.length === 0 ? (
                    <tr><td colSpan={4} className="p-4 text-center">No export data available in current packet.</td></tr>
                  ) : comtradeData.map((row, i) => (
                    <tr key={i} className="border-b border-slate-800 hover:bg-slate-800">
                      <td className="px-4 py-3 font-bold text-white">{row.partnerDesc}</td>
                      <td className="px-4 py-3">{row.refYear}</td>
                      <td className="px-4 py-3 text-green-400">${row.primaryValue.toLocaleString()}</td>
                      <td className="px-4 py-3">{row.netWgt.toLocaleString()}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        {/* COL 2: ACTION CENTER */}
        <div className="space-y-6">
          
          {/* LINK TO TIMBER TOOL */}
          <div className="bg-slate-900 border border-slate-800 rounded-xl p-6">
             <h2 className="text-lg font-semibold flex items-center gap-2 mb-4">
              <ExternalLink className="text-emerald-500" size={20} />
              Valuation Tools
            </h2>
            <a href="./market.html" className="block w-full bg-emerald-900/40 hover:bg-emerald-800/60 border border-emerald-700/50 text-emerald-100 font-bold py-4 rounded-lg text-center transition-all">
              ðŸŒ² OPEN TIMBER CALCULATOR
            </a>
            <p className="text-xs text-center text-slate-500 mt-2">Local Storage Enabled</p>
          </div>

          {/* TARIFFS */}
          <div className="bg-slate-900 border border-slate-800 rounded-xl p-6">
            <h2 className="text-lg font-semibold flex items-center gap-2 mb-4">
              <ShieldAlert className="text-amber-500" size={20} />
              Tariff Radar
            </h2>
            <div className="space-y-3">
               <div className="bg-slate-950 p-3 rounded border border-slate-800 flex justify-between items-center">
                  <div>
                    <div className="font-bold text-sm text-slate-200">China (Sec 301)</div>
                  </div>
                  <span className="text-xs font-bold px-2 py-1 rounded bg-red-900/50 text-red-400">CRITICAL 25%</span>
               </div>
               <div className="bg-slate-950 p-3 rounded border border-slate-800 flex justify-between items-center">
                  <div>
                    <div className="font-bold text-sm text-slate-200">EU (EUDR)</div>
                  </div>
                  <span className="text-xs font-bold px-2 py-1 rounded bg-amber-900/50 text-amber-400">WARNING 10%</span>
               </div>
            </div>
          </div>

          {/* LOBBYING */}
          <div className="bg-slate-900 border border-slate-800 rounded-xl p-6">
            <h2 className="text-lg font-semibold flex items-center gap-2 mb-4">
              <FileText className="text-purple-500" size={20} />
              Lobbying Generator
            </h2>
            <div className="space-y-3">
              <select 
                className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-sm text-slate-200"
                value={lobbyTarget}
                onChange={(e) => setLobbyTarget(e.target.value)}
              >
                <option value="USTR">USTR (Ambassador)</option>
                <option value="SENATE">US Senate (WI)</option>
              </select>
              <button 
                onClick={generateBrief}
                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded text-sm flex items-center justify-center gap-2"
              >
                <RefreshCw size={14} /> GENERATE BRIEF
              </button>
              <textarea 
                readOnly
                value={brief}
                placeholder="Brief will appear here..."
                className="w-full h-40 bg-slate-950 border border-slate-700 rounded p-3 text-xs font-mono text-green-400 resize-none focus:outline-none"
              />
            </div>
          </div>
        </div>
      </main>
    </div>
  );
}

export default App;
